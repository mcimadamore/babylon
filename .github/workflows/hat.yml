name: Build and Test Babylon JDK

on:
  workflow_call:
    inputs:
      platform:
        required: true
        type: string
      bootjdk-platform:
        required: true
        type: string
      runs-on:
        required: true
        type: string
      xcode-toolset-version:
        required: false
        type: string
      dry-run:
        required: false
        type: boolean
        default: false
      debug-suffix:
        required: false
        type: string
      static-suffix:
        required: false
        type: string

jobs:
  build_jdk_and_run_hat:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Install build dependencies for OpenJDK (adjust as needed)
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf make build-essential \
          libcups2-dev libx11-dev libxext-dev libxrender-dev \
          libxtst-dev libxt-dev libasound2-dev \
          libfreetype6-dev libfontconfig1-dev \
          libxrandr-dev libxinerama-dev libxdamage-dev \
          libxcomposite-dev libxi-dev libxmu-dev \
          wget unzip zip
    
    - name: 'Get the BootJDK'
      uses: ./.github/actions/get-bootjdk
      with:
          platform: ${{ inputs.bootjdk-platform }}

    - name: Configure and build OpenJDK
      run: |
        BOOT_JDK_PATH="${JAVA_HOME}"
        bash configure --with-boot-jdk="$BOOT_JDK_PATH" --with-version-pre=dev
        make images

    # Find the path to the built JDK (typically build/*/images/jdk)
    - name: Set JAVA_HOME and run hat command
      run: |
        # Find the jdk images directory
        export JAVA_HOME=${{ steps.bundles.outputs.jdk-path }}
        cd hat
        "$JAVA_HOME/bin/java" @hat/bld
